!function(){"use strict";angular.module("HousePointsApp",["ui.router","ngCookies","restangular","ngAnimate","LocalStorageModule","ngAria","ngMaterial"]).constant("StateErrorCodes",{Unauthenticated:"User not authenticated",Unauthorized:"Unauthorized"}).constant("configData",{kidsDataLifeSpan:6e4}).config(["$stateProvider","$urlRouterProvider","$locationProvider","$httpProvider","$animateProvider","$compileProvider",function(e,t,n,r,o,i){function s(e,t,n){var r=t.defer();return n.getAuthToken()?e.isLoggedInPromise().then(function(){e.logout(),r.resolve()},function(){r.resolve()}):r.resolve(),r.promise}function a(e,t,n){var r=t.defer(),o=this.self;return e.isLoggedInPromise()?e.isLoggedInPromise().then(function(e){o&&o.role?o.role===e.user.role?r.resolve(e.user.role):r.reject({message:n.Unauthorized,next:"unauthorized"}):r.resolve(e.user.role)},function(){r.reject({message:n.Unauthenticated,next:"login"})}):r.reject({message:n.Unauthenticated,next:"login"}),r.promise}o.classNameFilter(/animate/),i.debugInfoEnabled(!1),e.state("main",{url:"/",templateUrl:"main/main.html",controller:"MainController as mainVm",controllerAs:"mainVm",resolve:{isAuthenticated:a}}).state("unauthorized",{url:"/unauthorized",templateUrl:"Unauthorized.html"}).state("404",{url:"/notFound",templateUrl:"404.html"}).state("login",{url:"/login",templateUrl:"login/login.html",controller:"LoginController as loginVm",controllerAs:"loginVm",resolve:{isAlreadyLoggedIn:s}}).state("register",{url:"/register",templateUrl:"Register/register.html",controller:"RegisterController as registerVm",controllerAs:"registerVm",resolve:{isAlreadyLoggedIn:s}}).state("log",{url:"/log",templateUrl:"log/log.html",controller:"LogController as logVm",controllerAs:"logVm"}).state("kids",{"abstract":!0,url:"/child",template:"<ui-view/>"}).state("kids.add",{url:"/add",templateUrl:"main/parentView/AddChild/add-child.html",controller:"addChildController as childCtrl",controllerAs:"childCtrl"}).state("kids.display",{url:"/:childId",controller:"childDetailsController",controllerAs:"childDetailsVm",templateUrl:"main/parentView/childDetails/childDetails.html",resolve:{childDetails:["KidsService","$q",function(e,t){var n=t.defer();return e.getAll().then(function(e){n.resolve(e)}),n.promise}]}}),t.otherwise("/notFound"),n.html5Mode({enabled:!0,requireBase:!1}),r.interceptors.push("authInterceptor"),s.$inject=["AuthService","$q","StorageService"],a.$inject=["AuthService","$q","StateErrorCodes"]}]).run(["$rootScope","StateErrorCodes","$state",function(e,t,n){e.$on("$stateChangeError",function(e,t,r,o,i,s){s.next&&n.transitionTo(s.next)})}])}(),function(e){"use strict";e.controller("RegisterController",["UserService","$state","AuthService","logger",function(e,t,n,r){function o(o,i){o&&e.createUser(i).then(function(){r.logMessage({message:"redirecting to main",caller:"RegisterController.submit"}),n.login(i).then(function(){t.go("main")})},function(){r.logMessage({message:"error creating user",caller:"RegisterController.submit"})})}function i(){s.user={email:"",password:"",name:"",username:""},s.error=void 0}var s=this;s.user={},s.submit=o,i()}])}(angular.module("HousePointsApp")),function(e){"use strict";e.directive("usernameAvailableValidator",["$q","$timeout","UserService",function(e,t,n){return{restrict:"A",require:"ngModel",link:function(t,r,o,i){i.$asyncValidators.usernameAvailable=function(t){var r=e.defer();return n.checkUser(t).then(function(e){e.available?r.resolve():r.reject()}),r.promise}}}}])}(angular.module("HousePointsApp")),function(e){"use strict";e.controller("LoginController",["AuthService","$state",function(e,t){function n(n,r){n&&r.username&&r.password&&e.login(r).then(function(){t.go("main")},function(e){o.error=e})}function r(){o.user={password:"",username:""},o.error=void 0}var o=this;o.user={},o.submit=n,o.Auth=e,r()}])}(angular.module("HousePointsApp")),function(e){"use strict";function t(e){var t=this;t.Auth=e,t.showAdminView=t.Auth.hasRole("admin"),t.showChildView=t.Auth.hasRole("child"),t.showParentView=t.Auth.hasRole("parent")}e.controller("MainController",t),t.$inject=["AuthService"]}(angular.module("HousePointsApp")),function(e){"use strict";e.controller("LogController",["logger",function(e){var t=this;t.logger=e}])}(angular.module("HousePointsApp")),function(e){"use strict";e.directive("ajNavbar",["AuthService","$state",function(e,t){return{restrict:"EA",templateUrl:"Common/NavBar/NavBar.html",controller:function(){var n=this;n.isCollapsed=!0,n.Auth=e,n.logout=function(){n.Auth.logout(),n.isCollapsed=!0,t.go("login")}},controllerAs:"navBarVm"}}])}(angular.module("HousePointsApp")),function(e){"use strict";e.factory("AuthService",["$http","$q","UserService","StorageService",function(e,t,n,r){function o(){return d.hasOwnProperty("role")}function i(e){return d&&l.isLoggedIn()?d.role===e:!1}function s(){r.getAuthToken()&&(c=n.getLoggedInUser(),c.then(function(e){d=e.user}))}function a(){d={},c=void 0,r.removeAuthToken()}function u(o){var i=t.defer();return e.post("/auth/local",o).success(function(e){r.putAuthToken(e.token),c=n.getLoggedInUser(),c.then(function(e){d=e.user,i.resolve()},function(e){i.reject(e)})}).error(function(e){r.removeAuthToken(),i.reject(e)}),i.promise}var l,c,d={};return l={login:u,logout:a,getCurrentUser:function(){return d},setCurrentUser:function(e){d=e},isLoggedIn:o,isLoggedInPromise:function(){return c},hasRole:i},s(),l}])}(angular.module("HousePointsApp")),function(e){"use strict";e.factory("KidsService",["Restangular","$q","localStorageService","configData","$log",function(e,t,n,r,o){function i(){n.remove(d)}function s(e){var r=t.defer();return e&&angular.isObject(e)?c.post(e).then(function(e){n.remove(d),r.resolve(e)},function(e){r.reject(e)}):r.reject("Invalid parameters passed"),r.promise}function a(){var e=n.get(d),t=e&&e.creationTime?new Date-new Date(e.creationTime)>g:!0,r=e&&e.data&&e.creationTime&&!t;return r?e.data:null}function u(){var e=t.defer(),r=a();return a()?(o.info("from cache"),e.resolve(r)):(o.info("from server"),c.get("").then(function(t){var r=l(t.kids);n.set(d,{data:r,creationTime:new Date}),e.resolve(t.kids)},function(t){e.reject(t)})),e.promise}function l(e){return _.each(e,function(e){e.housePoints?e.totalPoints=_.reduce(e.housePoints,function(e,t){return e+t.points},0):(e.housePoints=[],e.totalPoints=0)}),e}var c=e.all("api/kids"),d="kids",g=r.kidsDataLifeSpan,f={getAll:u,addKid:s};return i(),f}])}(angular.module("HousePointsApp")),function(e){"use strict";e.factory("logger",function(){function e(e){var t=new n(e);r.messageLog.push(t)}function t(){r.messageLog=[]}function n(e){this.message=e.message||"",this.type=e.type||"",this.caller=e.caller||"",this.time=new Date}var r={};return r.messageLog=[],r.logMessage=e,r.clear=t,r})}(angular.module("HousePointsApp")),function(e){"use strict";e.factory("StorageService",["localStorageService",function(e){function t(){return e.get("token")}function n(){e.remove("token")}function r(t){null!==t&&void 0!==t&&e.set("token",t)}var o={getAuthToken:t,removeAuthToken:n,putAuthToken:r};return o}])}(angular.module("HousePointsApp")),function(e){"use strict";e.factory("UserService",["Restangular","capitalizeFilter","$q",function(e,t,n){function r(){return u.one("me").get()}function o(e){var t=n.defer();return u.post(e).then(function(){t.resolve()},function(){t.reject()}),t.promise}function i(){return u.getList()}function s(e){return u.one("checkUser",e).get()}var a=e.withConfig(function(e){e.addResponseInterceptor(function(e,n,r){var o=e;return"get"===n&&"me"===r&&(o.user.name=t(o.user.name)),"getList"===n&&(o=e.users),o})}),u=a.all("api/users");return{getLoggedInUser:r,getAllUsers:i,checkUser:s,createUser:o}}])}(angular.module("HousePointsApp")),function(e){"use strict";e.factory("authInterceptor",["$rootScope","$q","StorageService","$location",function(e,t,n,r){return{request:function(e){return e.headers=e.headers||{},n.getAuthToken()&&(e.headers.Authorization="Bearer "+n.getAuthToken()),e},responseError:function(e){return 401===e.status?(r.path("/login"),t.reject(e)):t.reject(e)}}}])}(angular.module("HousePointsApp")),function(e){"use strict";e.filter("capitalize",function(){return function(e){if(!e)return"";var t=e.substring(0,1).toUpperCase();return t+e.substring(1)}})}(angular.module("HousePointsApp")),function(e){"use strict";e.controller("addChildController",["$state","$log","KidsService",function(e,t,n){var r=this;r.child={name:""},r.submit=function(r,o){t.info(o),t.info(r),r&&o&&n.addKid(o).then(function(){e.go("main")})}}])}(angular.module("HousePointsApp")),function(e){"use strict";e.directive("adminView",function(){return{restrict:"E",templateUrl:"main/adminView/adminView.html",controller:["UserService",function(e){var t=this;t.users=[],e.getAllUsers().then(function(e){_.forEach(e,function(e){t.users.push(e)})})}],controllerAs:"adminVm"}})}(angular.module("HousePointsApp")),function(e){"use strict";e.directive("parentView",["$state","$log",function(e,t){return{restrict:"E",templateUrl:"main/parentView/parentView.html",controller:["KidsService",function(n){var r=this;r.kids=[],r.viewDetails=function(t){e.go("kids.display",{childId:t.data._id})},n.getAll().then(function(e){_.forEach(e,function(e){t.info(e),r.kids.push(e)})})}],controllerAs:"kidsVm"}}])}(angular.module("HousePointsApp")),function(e){"use strict";e.directive("loader",["$rootScope","$timeout",function(e,t){return{restrict:"A",replace:!0,templateUrl:"Common/directives/loader/loader.html",link:function(n,r,o){var i,s=o.minLoaderDisplay||300;n.data={startTime:void 0};var a=e.$on("$stateChangeStart",function(){n.data.startTime=new Date,r.removeClass("ng-hide")}),u=e.$on("$stateChangeSuccess",function(){var e=new Date-n.data.startTime,o=s-e;o=o>0?o:0,i=t(function(){r.addClass("ng-hide")},o)}),l=e.$on("$stateChangeError",function(){r.addClass("ng-hide")});n.$on("destroy",function(){a(),u(),l(),t.cancel(i)})}}}])}(angular.module("HousePointsApp")),function(e){"use strict";e.directive("ajUser",function(){return{restrict:"E",replace:!0,scope:{user:"="},templateUrl:"main/adminView/user/user.html"}})}(angular.module("HousePointsApp")),function(e){"use strict";e.controller("addChildController",["$state","$log","KidsService",function(e,t,n){var r=this;r.child={name:""},r.submit=function(r,o){t.info(o),t.info(r),r&&o&&n.addKid(o).then(function(){e.go("main")})}}])}(angular.module("HousePointsApp")),function(e){"use strict";e.directive("child",function(){return{restrict:"E",replace:!0,templateUrl:"main/parentView/child/child.html",scope:{kid:"="}}})}(angular.module("HousePointsApp")),function(e){"use strict";e.controller("childDetailsController",["childDetails","$stateParams",function(e,t){var n=this,r=t.childId;n.details=_.find(e,function(e){return e._id===r})}])}(angular.module("HousePointsApp"));